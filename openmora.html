<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Abrir app</title>
  <script>
    // ===== Config fija (sin query params) =====
    const SCHEME = "galicia";
    const CLICK_ACTION = "OPEN_MORA";   // fijo
    const MODULE = "xyz";               // fijo
    const HOST = CLICK_ACTION === "OPEN_MORA" ? "openmora" : "open";

    // Stores y package (ajustá estos tres según tu app)
    const IOS_STORE = "https://apps.apple.com/ar/app/id123456789";
    const ANDROID_STORE = "https://play.google.com/store/apps/details?id=com.example.app";
    const ANDROID_PACKAGE = "com.example.app";

    // Timeout iOS para fallback
    const IOS_TIMEOUT_MS = 2000; // 1500–2500 suele ir bien

    // ===== Helpers =====
    const isAndroid = () => /Android/i.test(navigator.userAgent);
    const isIOS = () => /iPhone|iPad|iPod/i.test(navigator.userAgent);

    function openApp() {
      // Construimos scheme con params fijos
      const qs = `?module=${encodeURIComponent(MODULE)}&click_action=${encodeURIComponent(CLICK_ACTION)}`;
      const schemeUrl = `${SCHEME}://${HOST}${qs}`;
      const fallback = isAndroid() ? ANDROID_STORE : IOS_STORE;

      // Cancelar fallback si la página pierde foco/visibilidad (la app se abrió)
      let timer = null;
      const cancelFallback = () => { if (timer) { clearTimeout(timer); timer = null; } };
      window.addEventListener("pagehide", cancelFallback, { once: true });
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden") cancelFallback();
      }, { passive: true });
      window.addEventListener("blur", cancelFallback, { passive: true });

      if (isAndroid()) {
        // Android: usar intent:// con fallback automático
        const intentUrl =
          `intent://${HOST}${qs}` +
          `#Intent;scheme=${SCHEME};package=${ANDROID_PACKAGE};S.browser_fallback_url=${encodeURIComponent(fallback)};end`;
        location.href = intentUrl;
      } else if (isIOS()) {
        // iOS: probar scheme y, si no abre, ir al Store tras timeout
        location.href = schemeUrl;
        timer = setTimeout(() => { location.href = fallback; }, IOS_TIMEOUT_MS);
      } else {
        // Desktop u otros
        location.href = fallback;
      }
    }

    window.addEventListener("load", openApp);
  </script>
</head>
<body>
  <p>Redirigiendo a la app… Si no abre, te llevamos a la tienda.</p>
</body>
</html>
</body>
</html>
